<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustArchiv - Syst√®me Complet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        .drag-over { border-color: #3b82f6 !important; background-color: rgba(59, 130, 246, 0.1) !important; }
        .toast { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .toast.show { transform: translateX(0); }
        .loading { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .vip-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .admin-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .user-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .tag { @apply inline-block bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full mr-1 mb-1; }
        .tag.selected { @apply bg-blue-500 text-white; }
        .permission-card { transition: all 0.3s ease; }
        .permission-card:hover { transform: translateY(-2px); }
        .stats-card { background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); backdrop-filter: blur(10px); }
        
        /* Dark Mode Styles */
        .dark { color-scheme: dark; }
        .dark body { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .dark .bg-white { background-color: #374151 !important; color: #f9fafb; }
        .dark .text-gray-800 { color: #f9fafb !important; }
        .dark .text-gray-600 { color: #d1d5db !important; }
        .dark .text-gray-500 { color: #9ca3af !important; }
        .dark .text-gray-400 { color: #6b7280 !important; }
        .dark .border-gray-200 { border-color: #4b5563 !important; }
        .dark .border-gray-300 { border-color: #6b7280 !important; }
        .dark .bg-gray-50 { background-color: #4b5563 !important; }
        .dark .bg-gray-100 { background-color: #374151 !important; }
        .dark .bg-gray-900 { background-color: #111827 !important; }
        .dark .hover\\:bg-gray-50:hover { background-color: #4b5563 !important; }
        .dark input, .dark textarea, .dark select { background-color: #4b5563; color: #f9fafb; border-color: #6b7280; }
        .dark input:focus, .dark textarea:focus, .dark select:focus { border-color: #3b82f6; }
        
        /* Theme Toggle Button */
        .theme-toggle { transition: transform 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1); }
        
        /* Chart containers */
        .chart-container { position: relative; height: 300px; }
        .chart-container canvas { max-height: 300px; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 flex items-center justify-center p-4">
        <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üèõÔ∏è</div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">JustArchiv</h1>
                <p class="text-gray-600 font-medium">Syst√®me de Gestion Documentaire</p>
                <div class="mt-2 text-xs text-gray-500">Version Compl√®te ‚Ä¢ Phase 3 ‚Ä¢ Graphiques & Mode Sombre</div>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" placeholder="votre@email.com" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="vip-mode" class="mr-2 rounded">
                    <label for="vip-mode" class="text-sm text-gray-700">üåü Mode D√©veloppeur VIP</label>
                </div>
                <button onclick="login()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    <span id="login-btn-text">Se connecter</span>
                    <div id="login-spinner" class="loading mx-auto hidden"></div>
                </button>
                <div class="text-center">
                    <button onclick="showRegister()" class="text-indigo-600 hover:text-indigo-800 font-medium">
                        Pas de compte ? S'inscrire
                    </button>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet</label>
                    <input type="text" id="register-name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="Jean Dupont" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="register-email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="votre@email.com" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="register-password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Code VIP (optionnel)</label>
                    <input type="text" id="vip-code" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all" placeholder="DEV2024, JUSTARCHIV_VIP..." />
                    <p class="text-xs text-gray-500 mt-1">Codes VIP: DEV2024, JUSTARCHIV_VIP, DEVELOPER_ACCESS</p>
                </div>
                <button onclick="register()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                    <span id="register-btn-text">S'inscrire</span>
                    <div id="register-spinner" class="loading mx-auto hidden"></div>
                </button>
                <div class="text-center">
                    <button onclick="showLogin()" class="text-indigo-600 hover:text-indigo-800 font-medium">
                        D√©j√† un compte ? Se connecter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md shadow-lg border-b border-gray-200/50 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <span class="text-3xl">üèõÔ∏è</span>
                        <div>
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">JustArchiv</h1>
                            <div class="text-xs text-gray-500">Phase 3 ‚Ä¢ Graphiques & Mode Sombre</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Theme Toggle -->
                        <button onclick="toggleTheme()" class="theme-toggle p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-all" title="Basculer le th√®me">
                            <span id="theme-icon">üåô</span>
                        </button>
                        <div class="text-right">
                            <div id="user-name" class="text-gray-800 font-medium"></div>
                            <div class="flex items-center space-x-2">
                                <span id="user-role" class="text-xs px-2 py-1 rounded-full"></span>
                                <span id="user-permissions" class="text-xs text-gray-500"></span>
                            </div>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all">
                            D√©connexion
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8 overflow-x-auto">
                    <button onclick="showSection('dashboard')" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap">
                        üìä Tableau de Bord
                    </button>
                    <button onclick="showSection('documents')" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap">
                        üìÑ Documents
                    </button>
                    <button onclick="showSection('categories')" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap">
                        üìÅ Cat√©gories
                    </button>
                    <button onclick="showSection('tags')" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap">
                        üè∑Ô∏è Tags
                    </button>
                    <button onclick="showSection('users')" id="users-nav" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap hidden">
                        üë• Utilisateurs
                    </button>
                    <button onclick="showSection('permissions')" id="permissions-nav" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap hidden">
                        üîê Permissions
                    </button>
                    <button onclick="showSection('settings')" class="nav-btn py-4 px-3 border-b-2 border-transparent hover:border-indigo-400 transition-all whitespace-nowrap">
                        ‚öôÔ∏è Configuration
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section fade-in">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üìä Tableau de Bord</h2>
                    <p class="text-gray-600">Vue d'ensemble avec graphiques interactifs</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stats-card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Documents</p>
                                <p id="stats-documents" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üìÑ</div>
                        </div>
                    </div>
                    <div class="stats-card bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Cat√©gories</p>
                                <p id="stats-categories" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üìÅ</div>
                        </div>
                    </div>
                    <div class="stats-card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Tags</p>
                                <p id="stats-tags" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üè∑Ô∏è</div>
                        </div>
                    </div>
                    <div class="stats-card bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">Utilisateurs</p>
                                <p id="stats-users" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üë•</div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Documents par mois -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìà Documents ajout√©s par mois</h3>
                        <div class="chart-container">
                            <canvas id="documentsChart"></canvas>
                        </div>
                    </div>

                    <!-- Top cat√©gories -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üèÜ Top Cat√©gories</h3>
                        <div class="chart-container">
                            <canvas id="categoriesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- R√©partition par utilisateur -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üë• Documents par utilisateur</h3>
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>

                    <!-- Tags populaires -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üè∑Ô∏è Tags les plus utilis√©s</h3>
                        <div class="chart-container">
                            <canvas id="tagsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìà Activit√© R√©cente</h3>
                    <div id="recent-activity" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <span class="text-4xl block mb-2">üìä</span>
                            <p>Chargement de l'activit√©...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div id="documents-section" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">üìÑ Gestion des Documents</h2>
                        <p class="text-gray-600">Organisez et g√©rez vos documents</p>
                    </div>
                    <button onclick="openDocumentModal()" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        + Nouveau Document
                    </button>
                </div>

                <!-- Advanced Search and Filters -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üîç Recherche Avanc√©e</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <input type="text" id="search-input" placeholder="üîç Rechercher..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all" />
                        </div>
                        <div>
                            <select id="category-filter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Toutes les cat√©gories</option>
                            </select>
                        </div>
                        <div>
                            <select id="user-filter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Tous les utilisateurs</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="clearFilters()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition-all">
                                Effacer
                            </button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                        <div id="tag-filters" class="flex flex-wrap gap-2">
                            <!-- Tags will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Documents Grid -->
                <div id="documents-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <span class="text-6xl mb-4 block">üìÑ</span>
                        <p class="text-xl mb-4">Chargement des documents...</p>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categories-section" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">üìÅ Gestion des Cat√©gories</h2>
                        <p class="text-gray-600">Organisez vos documents par cat√©gories</p>
                    </div>
                    <button onclick="openCategoryModal()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        + Nouvelle Cat√©gorie
                    </button>
                </div>

                <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <span class="text-6xl mb-4 block">üìÅ</span>
                        <p class="text-xl mb-4">Chargement des cat√©gories...</p>
                    </div>
                </div>
            </div>

            <!-- Tags Section -->
            <div id="tags-section" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">üè∑Ô∏è Gestion des Tags</h2>
                        <p class="text-gray-600">√âtiquetez vos documents pour une meilleure organisation</p>
                    </div>
                    <button onclick="openTagModal()" class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        + Nouveau Tag
                    </button>
                </div>

                <div id="tags-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <span class="text-6xl mb-4 block">üè∑Ô∏è</span>
                        <p class="text-xl mb-4">Chargement des tags...</p>
                    </div>
                </div>
            </div>

            <!-- Users Section (Admin/VIP only) -->
            <div id="users-section" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">üë• Gestion des Utilisateurs</h2>
                        <p class="text-gray-600">G√©rez les utilisateurs et leurs r√¥les</p>
                    </div>
                    <button onclick="openUserModal()" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                        + Nouvel Utilisateur
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">R√¥le</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documents</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derni√®re connexion</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                        <span class="text-4xl block mb-2">üë•</span>
                                        <p>Chargement des utilisateurs...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Permissions Section (VIP only) -->
            <div id="permissions-section" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">üîê Gestion des Permissions</h2>
                    <p class="text-gray-600">Configurez les permissions avanc√©es du syst√®me</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Role Permissions -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üëë Permissions par R√¥le</h3>
                        <div class="space-y-4">
                            <div class="permission-card border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-800">üåü VIP (D√©veloppeur)</span>
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Acc√®s Total</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>‚úÖ Gestion compl√®te des utilisateurs</div>
                                    <div>‚úÖ Configuration syst√®me</div>
                                    <div>‚úÖ Permissions avanc√©es</div>
                                    <div>‚úÖ Acc√®s √† tous les documents</div>
                                </div>
                            </div>
                            <div class="permission-card border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-800">üë®‚Äçüíº Admin</span>
                                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">√âlev√©</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>‚úÖ Gestion des utilisateurs</div>
                                    <div>‚úÖ Gestion des cat√©gories</div>
                                    <div>‚úÖ Acc√®s aux documents</div>
                                    <div>‚ùå Configuration syst√®me</div>
                                </div>
                            </div>
                            <div class="permission-card border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-800">üë§ Utilisateur</span>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Standard</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>‚úÖ Ses propres documents</div>
                                    <div>‚úÖ Cr√©ation de documents</div>
                                    <div>‚ùå Gestion des utilisateurs</div>
                                    <div>‚ùå Configuration syst√®me</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Param√®tres Syst√®me</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Inscription publique</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="public-registration" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Validation des documents</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="document-validation" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Notifications email</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="email-notifications" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        <button onclick="saveSystemSettings()" class="w-full mt-6 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                            üíæ Sauvegarder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">‚öôÔ∏è Configuration</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Supabase Configuration -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="mr-2">üîß</span>
                            Configuration Supabase
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">URL Supabase</label>
                                <input type="text" id="supabase-url" placeholder="https://votre-projet.supabase.co" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cl√© anonyme Supabase</label>
                                <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <button onclick="saveSupabaseConfig()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                üíæ Sauvegarder la configuration
                            </button>
                        </div>
                    </div>

                    <!-- Database Management -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="mr-2">üóÑÔ∏è</span>
                            Base de donn√©es
                        </h3>
                        <div class="space-y-4">
                            <button onclick="initializeDatabase()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                üöÄ Initialiser les tables
                            </button>
                            <button onclick="loadSampleData()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                üìä Charger des donn√©es d'exemple
                            </button>
                            <button onclick="exportData()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                üì§ Exporter les donn√©es
                            </button>
                            <button onclick="resetDatabase()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                üóëÔ∏è R√©initialiser (DANGER)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SQL Console (VIP only) -->
                <div id="sql-console" class="mt-8 bg-white rounded-xl shadow-lg p-6 hidden">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">üíª</span>
                        Console SQL (Mode D√©veloppeur)
                    </h3>
                    <div class="space-y-4">
                        <textarea id="sql-query" rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-mono text-sm" placeholder="SELECT * FROM documents;"></textarea>
                        <div class="flex space-x-4">
                            <button onclick="executeSQLQuery()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                                ‚ñ∂Ô∏è Ex√©cuter
                            </button>
                            <button onclick="clearSQLConsole()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                                üóëÔ∏è Effacer
                            </button>
                        </div>
                        <div id="sql-results" class="bg-gray-50 rounded-lg p-4 min-h-[100px] font-mono text-sm"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Document Modal -->
    <div id="document-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">üìÑ Gestion de Document</h3>
            </div>
            <form id="document-form" class="p-6 space-y-6">
                <input type="hidden" id="document-id" />
                
                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom du document *</label>
                        <input type="text" id="document-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie *</label>
                        <select id="document-category" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">S√©lectionner une cat√©gorie</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="document-description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <!-- Tags -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                    <div id="document-tags-container" class="border border-gray-300 rounded-lg p-3 min-h-[50px]">
                        <div id="selected-tags" class="flex flex-wrap gap-2 mb-2"></div>
                        <input type="text" id="tag-input" placeholder="Tapez pour ajouter des tags..." class="w-full border-none outline-none" />
                    </div>
                    <div id="available-tags" class="mt-2 flex flex-wrap gap-2"></div>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fichier</label>
                    <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span class="font-medium">Cliquez pour t√©l√©charger</span> ou glissez-d√©posez
                        </p>
                        <p class="text-xs text-gray-500">PDF, DOC, DOCX, TXT, JPG, PNG jusqu'√† 10MB</p>
                    </div>
                    <input type="file" id="document-file" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" class="hidden" />
                </div>

                <!-- Permissions (VIP/Admin only) -->
                <div id="document-permissions" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Permissions</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="doc-visibility" value="private" checked class="mr-2">
                            <span class="text-sm">üîí Priv√© (seulement moi)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="doc-visibility" value="team" class="mr-2">
                            <span class="text-sm">üë• √âquipe (utilisateurs de mon organisation)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="doc-visibility" value="public" class="mr-2">
                            <span class="text-sm">üåç Public (tous les utilisateurs)</span>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeModal('document-modal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                        Annuler
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                        <span id="document-submit-text">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">üìÅ Gestion de Cat√©gorie</h3>
            </div>
            <form id="category-form" class="p-6 space-y-4">
                <input type="hidden" id="category-id" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom de la cat√©gorie *</label>
                    <input type="text" id="category-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="category-description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Couleur</label>
                    <div class="flex space-x-2">
                        <button type="button" onclick="selectColor('blue')" class="w-10 h-10 bg-blue-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectColor('green')" class="w-10 h-10 bg-green-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectColor('purple')" class="w-10 h-10 bg-purple-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectColor('red')" class="w-10 h-10 bg-red-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectColor('yellow')" class="w-10 h-10 bg-yellow-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectColor('indigo')" class="w-10 h-10 bg-indigo-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                    </div>
                    <input type="hidden" id="category-color" value="blue" />
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal('category-modal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Annuler
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        <span id="category-submit-text">Cr√©er</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Modal -->
    <div id="tag-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">üè∑Ô∏è Gestion de Tag</h3>
            </div>
            <form id="tag-form" class="p-6 space-y-4">
                <input type="hidden" id="tag-id" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom du tag *</label>
                    <input type="text" id="tag-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Couleur</label>
                    <div class="flex space-x-2">
                        <button type="button" onclick="selectTagColor('gray')" class="w-8 h-8 bg-gray-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('red')" class="w-8 h-8 bg-red-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('yellow')" class="w-8 h-8 bg-yellow-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('green')" class="w-8 h-8 bg-green-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('blue')" class="w-8 h-8 bg-blue-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('indigo')" class="w-8 h-8 bg-indigo-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('purple')" class="w-8 h-8 bg-purple-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                        <button type="button" onclick="selectTagColor('pink')" class="w-8 h-8 bg-pink-500 rounded-full border-2 border-gray-300 hover:border-gray-500 transition-all"></button>
                    </div>
                    <input type="hidden" id="tag-color" value="gray" />
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal('tag-modal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Annuler
                    </button>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        <span id="tag-submit-text">Cr√©er</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal (Admin/VIP only) -->
    <div id="user-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">üë§ Gestion d'Utilisateur</h3>
            </div>
            <form id="user-form" class="p-6 space-y-4">
                <input type="hidden" id="user-id" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
                    <input type="text" id="user-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="user-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">R√¥le</label>
                    <select id="user-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="user">üë§ Utilisateur</option>
                        <option value="admin">üë®‚Äçüíº Administrateur</option>
                    </select>
                </div>
                <div id="vip-role-option" class="hidden">
                    <label class="flex items-center">
                        <input type="checkbox" id="make-vip" class="mr-2">
                        <span class="text-sm">üåü Promouvoir en VIP (D√©veloppeur)</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal('user-modal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Annuler
                    </button>
                    <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        <span id="user-submit-text">Cr√©er</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let supabase = null;
        let currentUser = null;
        let userProfile = null;
        let allDocuments = [];
        let allCategories = [];
        let allTags = [];
        let allUsers = [];
        let selectedTags = [];
        let charts = {}; // Store chart instances

        // VIP codes (in production, these would be in a secure backend)
        const VIP_CODES = ['DEV2024', 'JUSTARCHIV_VIP', 'DEVELOPER_ACCESS'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
            setupEventListeners();
            checkAuthState();
            initTheme();
            loadSettings();
        });

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').textContent = 'üåô';
                localStorage.setItem('theme', 'light');
                showToast('Mode clair activ√©', 'info');
            } else {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
                showToast('Mode sombre activ√©', 'info');
            }
            
            // Update charts for theme
            setTimeout(() => {
                updateChartsForTheme();
            }, 100);
        }

        function updateChartsForTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#f9fafb' : '#374151';
            const gridColor = isDark ? '#4b5563' : '#e5e7eb';

            Object.values(charts).forEach(chart => {
                if (chart && chart.options) {
                    // Update text colors
                    if (chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    if (chart.options.scales) {
                        Object.values(chart.options.scales).forEach(scale => {
                            if (scale.ticks) scale.ticks.color = textColor;
                            if (scale.grid) scale.grid.color = gridColor;
                        });
                    }
                    chart.update();
                }
            });
        }

        // Initialize Supabase with auto-configuration
        function initSupabase() {
            // Auto-configure with your Supabase credentials
            const url = 'https://pymlruomnsycgssxvjfi.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5bWxydW9tbnN5Y2dzc3h2amZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NDk2OTMsImV4cCI6MjA3MzAyNTY5M30.-GRmXqDAqLK9ETk_PYaqqVGujBz4f9IidNrDRssYCQ4';
            
            try {
                supabase = window.supabase.createClient(url, key);
                console.log('‚úÖ Supabase connect√© automatiquement');
                
                // Save to localStorage for settings display
                localStorage.setItem('supabase-url', url);
                localStorage.setItem('supabase-key', key);
                
                return true;
            } catch (error) {
                console.error('‚ùå Erreur Supabase:', error);
                showToast('Erreur de connexion Supabase', 'error');
                return false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('search-input').addEventListener('input', filterDocuments);
            document.getElementById('category-filter').addEventListener('change', filterDocuments);
            document.getElementById('user-filter').addEventListener('change', filterDocuments);

            // File upload
            const fileInput = document.getElementById('document-file');
            const dropZone = document.getElementById('file-drop-zone');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateFilePreview(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFilePreview(e.target.files[0]);
                }
            });

            // Tag input
            document.getElementById('tag-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTagToDocument(e.target.value.trim());
                    e.target.value = '';
                }
            });

            // Form submissions
            document.getElementById('document-form').addEventListener('submit', handleDocumentSubmit);
            document.getElementById('category-form').addEventListener('submit', handleCategorySubmit);
            document.getElementById('tag-form').addEventListener('submit', handleTagSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserSubmit);
        }

        // Check authentication state
        async function checkAuthState() {
            if (!supabase) return;

            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    showApp();
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Erreur auth:', error);
                showAuth();
            }
        }

        // Authentication functions
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const vipMode = document.getElementById('vip-mode').checked;

            if (!email || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }

            if (!supabase) {
                showToast('Veuillez configurer Supabase dans les param√®tres', 'error');
                showSection('settings');
                return;
            }

            setLoading('login', true);

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserProfile();

                // Check VIP mode
                if (vipMode && userProfile && userProfile.role !== 'vip') {
                    showToast('Mode VIP activ√© pour cette session', 'warning');
                    userProfile.role = 'vip'; // Temporary VIP for this session
                }

                showApp();
                showToast('Connexion r√©ussie !', 'success');
                
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showToast(error.message || 'Erreur de connexion', 'error');
            } finally {
                setLoading('login', false);
            }
        }

        async function register() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const vipCode = document.getElementById('vip-code').value.trim();

            if (!name || !email || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }

            if (!supabase) {
                showToast('Veuillez configurer Supabase dans les param√®tres', 'error');
                return;
            }

            setLoading('register', true);

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });

                if (error) throw error;

                // Determine role based on VIP code
                let role = 'user';
                if (vipCode && VIP_CODES.includes(vipCode.toUpperCase())) {
                    role = 'vip';
                    showToast('Code VIP valid√© ! Vous avez les privil√®ges d√©veloppeur.', 'success');
                }

                // Create user profile
                if (data.user) {
                    await supabase.from('users').insert([{
                        id: data.user.id,
                        name: name,
                        email: email,
                        role: role
                    }]);
                }

                showToast('Inscription r√©ussie ! V√©rifiez votre email.', 'success');
                showLogin();
                
            } catch (error) {
                console.error('Erreur d\'inscription:', error);
                showToast(error.message || 'Erreur d\'inscription', 'error');
            } finally {
                setLoading('register', false);
            }
        }

        async function logout() {
            try {
                if (supabase) {
                    await supabase.auth.signOut();
                }
                currentUser = null;
                userProfile = null;
                
                // Destroy charts
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                showAuth();
                showToast('D√©connexion r√©ussie', 'success');
            } catch (error) {
                console.error('Erreur de d√©connexion:', error);
                showToast('Erreur de d√©connexion', 'error');
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (data) {
                    userProfile = data;
                    updateUserInterface();
                }
            } catch (error) {
                console.error('Erreur profil:', error);
            }
        }

        function updateUserInterface() {
            if (!userProfile) return;

            document.getElementById('user-name').textContent = userProfile.name;
            
            const roleElement = document.getElementById('user-role');
            const permissionsElement = document.getElementById('user-permissions');
            
            switch (userProfile.role) {
                case 'vip':
                    roleElement.textContent = 'üåü VIP D√©veloppeur';
                    roleElement.className = 'vip-gradient text-white text-xs px-3 py-1 rounded-full';
                    permissionsElement.textContent = 'Acc√®s Total';
                    // Show VIP sections
                    document.getElementById('users-nav').classList.remove('hidden');
                    document.getElementById('permissions-nav').classList.remove('hidden');
                    document.getElementById('sql-console').classList.remove('hidden');
                    document.getElementById('vip-role-option').classList.remove('hidden');
                    document.getElementById('document-permissions').classList.remove('hidden');
                    break;
                case 'admin':
                    roleElement.textContent = 'üë®‚Äçüíº Administrateur';
                    roleElement.className = 'admin-gradient text-white text-xs px-3 py-1 rounded-full';
                    permissionsElement.textContent = 'Gestion Avanc√©e';
                    document.getElementById('users-nav').classList.remove('hidden');
                    break;
                default:
                    roleElement.textContent = 'üë§ Utilisateur';
                    roleElement.className = 'user-gradient text-white text-xs px-3 py-1 rounded-full';
                    permissionsElement.textContent = 'Acc√®s Standard';
            }
        }

        // UI functions
        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            loadAllData();
            showSection('dashboard');
        }

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            // Show selected section
            document.getElementById(section + '-section').classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('border-indigo-400');
            });
            event?.target?.classList?.add('border-indigo-400');

            // Load section-specific data
            if (section === 'dashboard') {
                updateDashboardStats();
                loadRecentActivity();
                setTimeout(() => {
                    createCharts();
                }, 100);
            }
        }

        function setLoading(type, loading) {
            const btnText = document.getElementById(`${type}-btn-text`);
            const spinner = document.getElementById(`${type}-spinner`);
            
            if (loading) {
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        // Toast notifications
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 min-w-[300px]`;
            toast.innerHTML = `
                <span class="text-xl">${icons[type]}</span>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;

            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Modal functions
        function openDocumentModal() {
            resetDocumentForm();
            document.getElementById('document-modal').classList.add('active');
            updateTagFilters();
        }

        function openCategoryModal() {
            resetCategoryForm();
            document.getElementById('category-modal').classList.add('active');
        }

        function openTagModal() {
            resetTagForm();
            document.getElementById('tag-modal').classList.add('active');
        }

        function openUserModal() {
            resetUserForm();
            document.getElementById('user-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Form reset functions
        function resetDocumentForm() {
            document.getElementById('document-form').reset();
            document.getElementById('document-id').value = '';
            document.getElementById('document-submit-text').textContent = 'Ajouter';
            selectedTags = [];
            updateSelectedTags();
        }

        function resetCategoryForm() {
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-submit-text').textContent = 'Cr√©er';
            document.getElementById('category-color').value = 'blue';
            selectColor('blue');
        }

        function resetTagForm() {
            document.getElementById('tag-form').reset();
            document.getElementById('tag-id').value = '';
            document.getElementById('tag-submit-text').textContent = 'Cr√©er';
            document.getElementById('tag-color').value = 'gray';
            selectTagColor('gray');
        }

        function resetUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-submit-text').textContent = 'Cr√©er';
        }

        // Color selection functions
        function selectColor(color) {
            document.getElementById('category-color').value = color;
            // Update visual selection
            document.querySelectorAll('#category-modal button[onclick^="selectColor"]').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-gray-400');
            });
            event.target.classList.add('ring-4', 'ring-gray-400');
        }

        function selectTagColor(color) {
            document.getElementById('tag-color').value = color;
            // Update visual selection
            document.querySelectorAll('#tag-modal button[onclick^="selectTagColor"]').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-gray-400');
            });
            event.target.classList.add('ring-4', 'ring-gray-400');
        }

        // Tag management for documents
        function addTagToDocument(tagName) {
            if (!tagName || selectedTags.includes(tagName)) return;
            
            selectedTags.push(tagName);
            updateSelectedTags();
            
            // Clear input
            const input = document.getElementById('tag-input');
            if (input) input.value = '';
        }

        function removeTagFromDocument(tagName) {
            selectedTags = selectedTags.filter(tag => tag !== tagName);
            updateSelectedTags();
        }

        function updateSelectedTags() {
            const container = document.getElementById('selected-tags');
            if (container) {
                container.innerHTML = selectedTags.map(tag => `
                    <span class="tag bg-blue-100 text-blue-800 cursor-pointer" onclick="removeTagFromDocument('${tag}')">
                        ${tag} ‚úï
                    </span>
                `).join('');
            }
        }

        // Filter functions
        function filterDocuments() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const userFilter = document.getElementById('user-filter').value;
            
            let filteredDocs = allDocuments.filter(doc => {
                const matchesSearch = !searchTerm || 
                    doc.name.toLowerCase().includes(searchTerm) ||
                    (doc.description && doc.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || doc.category_id === categoryFilter;
                const matchesUser = !userFilter || doc.user_id === userFilter;
                
                return matchesSearch && matchesCategory && matchesUser;
            });
            
            displayFilteredDocuments(filteredDocs);
        }

        function displayFilteredDocuments(documents) {
            const grid = document.getElementById('documents-grid');
            
            if (documents.length > 0) {
                grid.innerHTML = documents.map(doc => `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <div class="p-4">
                            <div class="flex items-center mb-3">
                                <div class="text-3xl mr-3">${getFileIcon(doc.file_type)}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800 text-sm truncate">${doc.name}</h3>
                                    <p class="text-xs text-gray-500">${doc.categories?.name || 'Sans cat√©gorie'}</p>
                                    <p class="text-xs text-gray-400">par ${doc.users?.name || 'Inconnu'}</p>
                                </div>
                                <div class="text-xs">
                                    ${doc.visibility === 'private' ? 'üîí' : doc.visibility === 'team' ? 'üë•' : 'üåç'}
                                </div>
                            </div>
                            
                            ${doc.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${doc.description}</p>` : ''}
                            
                            ${doc.document_tags && doc.document_tags.length > 0 ? `
                                <div class="mb-3">
                                    ${doc.document_tags.map(dt => `<span class="tag bg-${dt.tags.color}-100 text-${dt.tags.color}-800">${dt.tags.name}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                                <span>${doc.file_size ? formatFileSize(doc.file_size) : 'N/A'}</span>
                                <span>${new Date(doc.created_at).toLocaleDateString('fr-FR')}</span>
                            </div>
                            
                            <div class="flex space-x-1">
                                ${doc.file_url ? `<button onclick="window.open('${doc.file_url}', '_blank')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-2 rounded transition-all">üëÅÔ∏è</button>` : ''}
                                <button onclick="editDocument('${doc.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs py-2 px-2 rounded transition-all">‚úèÔ∏è</button>
                                <button onclick="deleteDocument('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs py-2 px-2 rounded transition-all">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <span class="text-6xl mb-4 block">üîç</span>
                        <p class="text-xl mb-4">Aucun document trouv√©</p>
                        <button onclick="clearFilters()" class="text-blue-600 hover:text-blue-800 font-medium">
                            Effacer les filtres
                        </button>
                    </div>
                `;
            }
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('user-filter').value = '';
            
            // Clear tag filters
            document.querySelectorAll('#tag-filters .tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            displayDocuments();
        }

        function toggleTagFilter(tagId) {
            const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
            if (tagElement) {
                tagElement.classList.toggle('selected');
                filterDocuments();
            }
        }

        // File handling functions
        function updateFilePreview(file) {
            const dropZone = document.getElementById('file-drop-zone');
            dropZone.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-2">${getFileIcon(file.type)}</div>
                    <p class="text-sm font-medium text-gray-900">${file.name}</p>
                    <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                    <button type="button" onclick="clearFile()" class="mt-2 text-red-600 hover:text-red-800 text-sm">
                        Supprimer
                    </button>
                </div>
            `;
        }

        function clearFile() {
            document.getElementById('document-file').value = '';
            const dropZone = document.getElementById('file-drop-zone');
            dropZone.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-2 text-sm text-gray-600">
                    <span class="font-medium">Cliquez pour t√©l√©charger</span> ou glissez-d√©posez
                </p>
                <p class="text-xs text-gray-500">PDF, DOC, DOCX, TXT, JPG, PNG jusqu'√† 10MB</p>
            `;
        }

        function getFileIcon(fileType) {
            if (!fileType) return 'üìÑ';
            
            if (fileType.includes('pdf')) return 'üìï';
            if (fileType.includes('word') || fileType.includes('document')) return 'üìò';
            if (fileType.includes('text')) return 'üìù';
            if (fileType.includes('image')) return 'üñºÔ∏è';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'üìà';
            
            return 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Chart Creation Functions
        function createCharts() {
            createDocumentsChart();
            createCategoriesChart();
            createUsersChart();
            createTagsChart();
        }

        function createDocumentsChart() {
            const ctx = document.getElementById('documentsChart');
            if (!ctx) return;

            // Destroy existing chart
            if (charts.documents) {
                charts.documents.destroy();
            }

            // Get documents by month
            const monthlyData = getDocumentsByMonth();
            const isDark = document.documentElement.classList.contains('dark');

            charts.documents = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Documents ajout√©s',
                        data: monthlyData.data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: isDark ? '#f9fafb' : '#374151'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: isDark ? '#f9fafb' : '#374151'
                            },
                            grid: {
                                color: isDark ? '#4b5563' : '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                color: isDark ? '#f9fafb' : '#374151'
                            },
                            grid: {
                                color: isDark ? '#4b5563' : '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        function createCategoriesChart() {
            const ctx = document.getElementById('categoriesChart');
            if (!ctx) return;

            // Destroy existing chart
            if (charts.categories) {
                charts.categories.destroy();
            }

            const categoryData = getCategoryData();
            const isDark = document.documentElement.classList.contains('dark');

            charts.categories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.labels,
                    datasets: [{
                        data: categoryData.data,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#8b5cf6', '#ef4444', '#f59e0b', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: isDark ? '#f9fafb' : '#374151',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createUsersChart() {
            const ctx = document.getElementById('usersChart');
            if (!ctx) return;

            // Destroy existing chart
            if (charts.users) {
                charts.users.destroy();
            }

            const userData = getUserData();
            const isDark = document.documentElement.classList.contains('dark');

            charts.users = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: userData.labels,
                    datasets: [{
                        label: 'Documents',
                        data: userData.data,
                        backgroundColor: '#10b981',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: isDark ? '#f9fafb' : '#374151'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: isDark ? '#f9fafb' : '#374151'
                            },
                            grid: {
                                color: isDark ? '#4b5563' : '#e5e7eb'
                            }
                        },
                        x: {
                            ticks: {
                                color: isDark ? '#f9fafb' : '#374151'
                            },
                            grid: {
                                color: isDark ? '#4b5563' : '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        function createTagsChart() {
            const ctx = document.getElementById('tagsChart');
            if (!ctx) return;

            // Destroy existing chart
            if (charts.tags) {
                charts.tags.destroy();
            }

            const tagData = getTagData();
            const isDark = document.documentElement.classList.contains('dark');

            charts.tags = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: tagData.labels,
                    datasets: [{
                        data: tagData.data,
                        backgroundColor: [
                            '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: isDark ? '#f9fafb' : '#374151',
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        r: {
                            ticks: {
                                color: isDark ? '#f9fafb' : '#374151'
                            },
                            grid: {
                                color: isDark ? '#4b5563' : '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // Data processing functions for charts
        function getDocumentsByMonth() {
            const months = [];
            const data = [];
            const now = new Date();
            
            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                months.push(monthName);
                
                const count = allDocuments.filter(doc => {
                    const docDate = new Date(doc.created_at);
                    return docDate.getMonth() === date.getMonth() && docDate.getFullYear() === date.getFullYear();
                }).length;
                
                data.push(count);
            }
            
            return { labels: months, data: data };
        }

        function getCategoryData() {
            const categoryStats = {};
            
            allCategories.forEach(category => {
                const count = allDocuments.filter(doc => doc.category_id === category.id).length;
                if (count > 0) {
                    categoryStats[category.name] = count;
                }
            });
            
            // Sort by count and take top 6
            const sorted = Object.entries(categoryStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);
            
            return {
                labels: sorted.map(([name]) => name),
                data: sorted.map(([,count]) => count)
            };
        }

        function getUserData() {
            const userStats = {};
            
            allUsers.forEach(user => {
                const count = allDocuments.filter(doc => doc.user_id === user.id).length;
                if (count > 0) {
                    userStats[user.name] = count;
                }
            });
            
            // Sort by count and take top 10
            const sorted = Object.entries(userStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            return {
                labels: sorted.map(([name]) => name),
                data: sorted.map(([,count]) => count)
            };
        }

        function getTagData() {
            const tagStats = {};
            
            allTags.forEach(tag => {
                const count = allDocuments.filter(doc => 
                    doc.document_tags && doc.document_tags.some(dt => dt.tags.id === tag.id)
                ).length;
                if (count > 0) {
                    tagStats[tag.name] = count;
                }
            });
            
            // Sort by count and take top 6
            const sorted = Object.entries(tagStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);
            
            return {
                labels: sorted.map(([name]) => name),
                data: sorted.map(([,count]) => count)
            };
        }

        // Configuration functions
        function saveSupabaseConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            localStorage.setItem('supabase-url', url);
            localStorage.setItem('supabase-key', key);
            
            if (initSupabase()) {
                showToast('Configuration Supabase sauvegard√©e !', 'success');
            }
        }

        async function initializeDatabase() {
            if (!supabase) {
                showToast('Veuillez d\'abord configurer Supabase', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.from('categories').select('*').limit(1);
                
                if (error) {
                    showToast('Erreur: Cr√©ez les tables SQL dans Supabase (voir console)', 'error');
                    console.log(`
üöÄ CR√âEZ CES TABLES DANS SUPABASE SQL EDITOR:

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Table des cat√©gories
CREATE TABLE categories (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    color VARCHAR(50) DEFAULT 'blue',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des utilisateurs
CREATE TABLE users (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    role VARCHAR(50) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP
);

-- Table des tags
CREATE TABLE tags (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    color VARCHAR(50) DEFAULT 'gray',
    created_at TIMESTAMP DEFAULT NOW()
);

-- Table des documents
CREATE TABLE documents (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    file_name VARCHAR(255),
    file_size INTEGER,
    file_type VARCHAR(100),
    file_url TEXT,
    category_id UUID REFERENCES categories(id),
    user_id UUID REFERENCES users(id),
    visibility VARCHAR(20) DEFAULT 'private',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Table de liaison documents-tags
CREATE TABLE document_tags (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(document_id, tag_id)
);

-- Table des permissions
CREATE TABLE permissions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    resource_type VARCHAR(50),
    resource_id UUID,
    permission_type VARCHAR(50),
    granted_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Table des activit√©s
CREATE TABLE activities (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id UUID,
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Activer RLS
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE document_tags ENABLE ROW LEVEL SECURITY;
ALTER TABLE permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE activities ENABLE ROW LEVEL SECURITY;

-- Politiques (d√©veloppement - √† s√©curiser en production)
CREATE POLICY "Allow all" ON categories FOR ALL USING (true);
CREATE POLICY "Allow all" ON users FOR ALL USING (true);
CREATE POLICY "Allow all" ON documents FOR ALL USING (true);
CREATE POLICY "Allow all" ON tags FOR ALL USING (true);
CREATE POLICY "Allow all" ON document_tags FOR ALL USING (true);
CREATE POLICY "Allow all" ON permissions FOR ALL USING (true);
CREATE POLICY "Allow all" ON activities FOR ALL USING (true);

-- Cr√©er le bucket pour les documents
INSERT INTO storage.buckets (id, name, public) VALUES ('documents', 'documents', true);

-- Politique pour le storage
CREATE POLICY "Allow all" ON storage.objects FOR ALL USING (true);
                    `);
                } else {
                    showToast('Base de donn√©es initialis√©e !', 'success');
                    loadAllData();
                }
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showToast('Erreur d\'initialisation', 'error');
            }
        }

        async function loadSampleData() {
            if (!supabase) {
                showToast('Veuillez d\'abord configurer Supabase', 'error');
                return;
            }

            try {
                // Add sample categories
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .insert([
                        { name: 'Documents Administratifs', description: 'Factures, contrats, documents officiels', color: 'blue' },
                        { name: 'Rapports', description: 'Rapports d\'activit√©, analyses, √©tudes', color: 'green' },
                        { name: 'Ressources Humaines', description: 'Documents RH, formations, √©valuations', color: 'purple' },
                        { name: 'Marketing', description: 'Supports marketing, campagnes, visuels', color: 'red' },
                        { name: 'Technique', description: 'Documentation technique, manuels', color: 'indigo' },
                        { name: 'Juridique', description: 'Contrats, accords, documents l√©gaux', color: 'yellow' }
                    ])
                    .select();

                if (catError) throw catError;

                // Add sample tags
                const { data: tags, error: tagError } = await supabase
                    .from('tags')
                    .insert([
                        { name: 'urgent', color: 'red' },
                        { name: 'confidentiel', color: 'purple' },
                        { name: 'archive', color: 'gray' },
                        { name: 'en-cours', color: 'yellow' },
                        { name: 'valid√©', color: 'green' },
                        { name: 'brouillon', color: 'blue' },
                        { name: 'important', color: 'orange' },
                        { name: 'public', color: 'indigo' }
                    ])
                    .select();

                if (tagError) throw tagError;

                showToast('Donn√©es d\'exemple charg√©es !', 'success');
                loadAllData();
            } catch (error) {
                console.error('Erreur donn√©es exemple:', error);
                showToast('Erreur lors du chargement des donn√©es', 'error');
            }
        }

        async function exportData() {
            if (!supabase) {
                showToast('Veuillez d\'abord configurer Supabase', 'error');
                return;
            }

            try {
                const exportData = {
                    categories: allCategories,
                    tags: allTags,
                    documents: allDocuments.map(doc => ({
                        ...doc,
                        file_url: null // Don't export file URLs for security
                    })),
                    users: allUsers.map(user => ({
                        id: user.id,
                        name: user.name,
                        email: user.email,
                        role: user.role
                    })),
                    exported_at: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `justarchiv_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Donn√©es export√©es avec succ√®s !', 'success');
            } catch (error) {
                console.error('Erreur export:', error);
                showToast('Erreur lors de l\'export', 'error');
            }
        }

        async function resetDatabase() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action supprimera TOUTES les donn√©es. √ätes-vous s√ªr ?')) return;
            if (!confirm('Cette action est IRR√âVERSIBLE. Confirmez-vous ?')) return;

            try {
                await supabase.from('document_tags').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('documents').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('categories').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('tags').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('activities').delete().neq('id', '00000000-0000-0000-0000-000000000000');

                showToast('Base de donn√©es r√©initialis√©e', 'warning');
                loadAllData();
            } catch (error) {
                console.error('Erreur reset:', error);
                showToast('Erreur lors de la r√©initialisation', 'error');
            }
        }

        // Data loading functions
        async function loadAllData() {
            if (!supabase) return;

            try {
                await Promise.all([
                    loadCategories(),
                    loadTags(),
                    loadDocuments(),
                    loadUsers()
                ]);
                updateDashboardStats();
                
                // Recreate charts if dashboard is visible
                if (!document.getElementById('dashboard-section').classList.contains('hidden')) {
                    setTimeout(() => {
                        createCharts();
                    }, 100);
                }
            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
        }

        async function loadCategories() {
            try {
                const { data: categories, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allCategories = categories || [];
                displayCategories();
                updateCategorySelects();

            } catch (error) {
                console.error('Erreur chargement cat√©gories:', error);
            }
        }

        async function loadTags() {
            try {
                const { data: tags, error } = await supabase
                    .from('tags')
                    .select('*')
                    .order('name');

                if (error) throw error;

                allTags = tags || [];
                displayTags();
                updateTagFilters();

            } catch (error) {
                console.error('Erreur chargement tags:', error);
            }
        }

        async function loadDocuments() {
            try {
                const { data: documents, error } = await supabase
                    .from('documents')
                    .select(`
                        *,
                        categories (name, color),
                        users (name),
                        document_tags (
                            tags (id, name, color)
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allDocuments = documents || [];
                displayDocuments();

            } catch (error) {
                console.error('Erreur chargement documents:', error);
            }
        }

        async function loadUsers() {
            try {
                if (userProfile?.role !== 'vip' && userProfile?.role !== 'admin') return;

                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allUsers = users || [];
                displayUsers();
                updateUserFilters();

            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const { data: activities, error } = await supabase
                    .from('activities')
                    .select(`
                        *,
                        users (name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                displayRecentActivity(activities || []);

            } catch (error) {
                console.error('Erreur chargement activit√©:', error);
            }
        }

        // Display functions
        function displayCategories() {
            const grid = document.getElementById('categories-grid');
            
            if (allCategories.length > 0) {
                grid.innerHTML = allCategories.map(category => `
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border-l-4 border-${category.color}-500">
                        <div class="flex items-center mb-4">
                            <span class="text-4xl mr-4">üìÅ</span>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800">${category.name}</h3>
                                <p class="text-sm text-gray-500">${getDocumentCountByCategory(category.id)} documents</p>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-4">${category.description || 'Aucune description'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500 bg-${category.color}-100 text-${category.color}-800 px-3 py-1 rounded-full">
                                ${category.color}
                            </span>
                            <div class="flex space-x-2">
                                <button onclick="editCategory('${category.id}')" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                                    ‚úèÔ∏è Modifier
                                </button>
                                <button onclick="deleteCategory('${category.id}')" class="text-red-600 hover:text-red-800 font-medium text-sm">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <span class="text-6xl mb-4 block">üìÅ</span>
                        <p class="text-xl mb-4">Aucune cat√©gorie cr√©√©e</p>
                        <button onclick="openCategoryModal()" class="text-blue-600 hover:text-blue-800 font-medium">
                            Cr√©er votre premi√®re cat√©gorie
                        </button>
                    </div>
                `;
            }
        }

        function displayTags() {
            const grid = document.getElementById('tags-grid');
            
            if (allTags.length > 0) {
                grid.innerHTML = allTags.map(tag => `
                    <div class="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 border-l-4 border-${tag.color}-500">
                        <div class="flex items-center justify-between mb-2">
                            <span class="tag bg-${tag.color}-100 text-${tag.color}-800 font-medium">${tag.name}</span>
                            <span class="text-xs text-gray-500">${getDocumentCountByTag(tag.id)} docs</span>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="editTag('${tag.id}')" class="text-blue-600 hover:text-blue-800 text-xs">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="deleteTag('${tag.id}')" class="text-red-600 hover:text-red-800 text-xs">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-16">
                        <span class="text-6xl mb-4 block">üè∑Ô∏è</span>
                        <p class="text-xl mb-4">Aucun tag cr√©√©</p>
                        <button onclick="openTagModal()" class="text-blue-600 hover:text-blue-800 font-medium">
                            Cr√©er votre premier tag
                        </button>
                    </div>
                `;
            }
        }

        function displayDocuments() {
            const grid = document.getElementById('documents-grid');
            
            if (allDocuments.length > 0) {
                grid.innerHTML = allDocuments.map(doc => `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <div class="p-4">
                            <div class="flex items-center mb-3">
                                <div class="text-3xl mr-3">${getFileIcon(doc.file_type)}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800 text-sm truncate">${doc.name}</h3>
                                    <p class="text-xs text-gray-500">${doc.categories?.name || 'Sans cat√©gorie'}</p>
                                    <p class="text-xs text-gray-400">par ${doc.users?.name || 'Inconnu'}</p>
                                </div>
                                <div class="text-xs">
                                    ${doc.visibility === 'private' ? 'üîí' : doc.visibility === 'team' ? 'üë•' : 'üåç'}
                                </div>
                            </div>
                            
                            ${doc.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${doc.description}</p>` : ''}
                            
                            ${doc.document_tags && doc.document_tags.length > 0 ? `
                                <div class="mb-3">
                                    ${doc.document_tags.map(dt => `<span class="tag bg-${dt.tags.color}-100 text-${dt.tags.color}-800">${dt.tags.name}</span>`).join('')}
                                <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c99b264037488f',t:'MTc1NzQ1MTUzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
